name: 🏆 Enterprise Quality Gates - Next.js 15.x

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master]

jobs:
  # Job 1: Código e Quality Gates
  quality-gates:
    name: 🎯 Zero Tolerance Quality Control
    runs-on: ubuntu-latest
    
    steps:
    - name: 📂 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: 📦 Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests  # Para integration tests
        
    - name: 🔍 Run Enterprise Quality Audit
      id: audit
      run: |
        python archive/legacy-code/kaike_audit.py . --json audit_results.json
        echo "audit_exit_code=$?" >> $GITHUB_OUTPUT
        
    - name: 🚨 Execute Quality Gates
      run: |
        python quality_gates.py audit_results.json

    - name: �️ Check Image Optimization
      run: |
        echo "🔍 Checking for unoptimized <img> tags..."
        
        # Buscar <img> tags não otimizadas
        if grep -r '<img[^>]*src=' "frontend/app" "frontend/components" --include="*.tsx" --include="*.jsx"; then
          echo "❌ FOUND UNOPTIMIZED <img> TAGS"
          echo "Replace with next/image component for:"
          echo "- Automatic WebP/AVIF conversion"
          echo "- Lazy loading"
          echo "- Responsive sizing"
          exit 1
        else
          echo "✅ No unoptimized <img> tags found"
        fi

    - name: 💬 Comment PR Results  
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          
          try {
            const auditData = JSON.parse(fs.readFileSync('audit_results.json', 'utf8'));
            const findings = auditData.findings || [];
            const high = findings.filter(f => f.severity === 'HIGH');
            const medium = findings.filter(f => f.severity === 'MEDIUM');
            const low = findings.filter(f => f.severity === 'LOW');
            
            const status = high.length === 0 ? '🏆 **QUALITY GATES PASSED**' : '❌ **QUALITY GATES FAILED**';
            
            const body = `${status}
            
            ## 📊 Code Quality Summary
            - **HIGH**: ${high.length} findings
            - **MEDIUM**: ${medium.length} findings  
            - **LOW**: ${low.length} findings
            
            ${high.length > 0 ? '### 🚨 HIGH Priority Issues\n' + high.map(h => `- ${h.message}`).join('\n') : ''}
            
            ### 🎯 Enterprise Standards
            ✅ Zero HIGH findings required for merge
            ✅ Function complexity < 120 lines
            ✅ No unoptimized <img> tags
            ✅ Bundle size within budget
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } catch (error) {
            console.log('Could not post comment:', error);
          }
        
    - name: ❌ Fail on Quality Gate Violations
      run: |
        python -c "
        import json, sys
        
        with open('audit_results.json') as f:
            data = json.load(f)
        
        high_findings = [f for f in data.get('findings', []) if f.get('severity') == 'HIGH']
        
        if high_findings:
            print(f'❌ BLOCKING MERGE: {len(high_findings)} HIGH severity findings detected')
            for finding in high_findings:
                print(f'  - {finding.get(\"message\", \"Unknown issue\")}')
            sys.exit(1)
        else:
            print('✅ All quality gates passed - merge approved')
        "

  # Job 2: Frontend Bundle Analysis  
  bundle-analysis:
    name: 📦 Bundle Size & Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: 📂 Checkout Code
      uses: actions/checkout@v4
      
    - name: 📱 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: 📦 Install Dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: 🏗️ Build with Bundle Analysis
      working-directory: ./frontend
      run: |
        ANALYZE=true npm run build
      env:
        NODE_ENV: production
        
    - name: 📊 Check Bundle Size Budget
      working-directory: ./frontend
      run: |
        echo "🔍 Checking bundle size budget..."
        
        # Verificar se .next/static existe
        if [ ! -d ".next/static" ]; then
          echo "❌ Build artifacts not found"
          exit 1
        fi
        
                # Tamanho total do bundle (todos arquivos em .next/static), em bytes
        bundle_size=$(du -sb .next/static | cut -f1)
        bundle_size_kb=$((bundle_size / 1024))
        
        echo "Bundle size: ${bundle_size}B (${bundle_size_kb}KB)"
        
        AGGRESSIVE_TARGET=512000   # 512 KB (warning apenas)
        HARD_LIMIT=1048576         # 1 MB  (hard limit)
        CURRENT_BRANCH="${GITHUB_REF_NAME:-unknown}"
        
        if [ "$bundle_size" -gt "$AGGRESSIVE_TARGET" ]; then
          echo "⚠️  WARNING: Bundle size ${bundle_size}B > aggressive target ${AGGRESSIVE_TARGET}B (512KB)"
        else
          echo "✅ Bundle size within aggressive target (${bundle_size}B <= ${AGGRESSIVE_TARGET}B)"
        fi
        
        if [ "$bundle_size" -gt "$HARD_LIMIT" ]; then
          if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
            echo "❌ BUNDLE SIZE EXCEEDED HARD LIMIT on main/master: ${bundle_size}B > ${HARD_LIMIT}B (~1MB)"
            exit 1
          else
            echo "⚠️  WARNING: Bundle size ${bundle_size}B exceeds hard limit ${HARD_LIMIT}B on branch ${CURRENT_BRANCH}, but build will not fail on non-main branches."
          fi
        else
          echo "✅ Bundle size within hard limit: ${bundle_size}B <= ${HARD_LIMIT}B"
        fi

  # Job 3: Integration Tests
  integration-tests:
    name: 🔌 Integration Tests
    runs-on: ubuntu-latest
    
    # services:
    #   # Setup para FastAPI se necessário
    #   # backend:
    #   #   image: python:3.11
    #   #   options: --health-cmd "curl -f http://localhost:8000/health || exit 1"
    
    steps:
    - name: 📂 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📱 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
        
    - name: 📦 Install All Dependencies
      run: |
        # Python
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests
        
        # Node.js
        cd frontend
        npm ci
        
    - name: 🚀 Start Backend (Background)
      run: |
        python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
        echo $! > backend.pid
        
        # Wait for backend to be ready
        echo "⏳ Waiting for backend..."
        for i in {1..30}; do
          if curl -s http://localhost:8000/data/status > /dev/null; then
            echo "✅ Backend ready"
            break
          fi
          sleep 2
        done
        
    - name: 🌐 Start Frontend (Background)
      working-directory: ./frontend
      run: |
        npm run dev &
        echo $! > frontend.pid
        
        # Wait for frontend to be ready
        echo "⏳ Waiting for frontend..."
        for i in {1..30}; do
          if curl -s http://localhost:3000 > /dev/null; then
            echo "✅ Frontend ready"
            break
          fi
          sleep 2
        done
        
    - name: 🧪 Run Integration Tests
      run: |
        python .ci/check_integration.py --ci
        
    - name: 🛑 Cleanup Processes
      if: always()
      run: |
        # Kill processes
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) || true
        fi
        if [ -f "frontend/frontend.pid" ]; then
          kill $(cat "frontend/frontend.pid") || true
        fi

