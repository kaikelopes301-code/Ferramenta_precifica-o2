name: ğŸ† Enterprise Quality Gates - Next.js 15.x

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  # Job 1: CÃ³digo e Quality Gates
  quality-gates:
    name: ğŸ¯ Zero Tolerance Quality Control
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests  # Para integration tests
        
    - name: ğŸ” Run Enterprise Quality Audit
      id: audit
      run: |
        python kaike_audit.py . --json audit_results.json
        echo "audit_exit_code=$?" >> $GITHUB_OUTPUT
        
    - name: ğŸš¨ Execute Quality Gates
      run: |
        python quality_gates.py audit_results.json

    - name: ï¿½ï¸ Check Image Optimization
      run: |
        echo "ğŸ” Checking for unoptimized <img> tags..."
        
        # Buscar <img> tags nÃ£o otimizadas
        if grep -r '<img[^>]*src=' "apenas site/app" "apenas site/components" --include="*.tsx" --include="*.jsx"; then
          echo "âŒ FOUND UNOPTIMIZED <img> TAGS"
          echo "Replace with next/image component for:"
          echo "- Automatic WebP/AVIF conversion"
          echo "- Lazy loading"
          echo "- Responsive sizing"
          exit 1
        else
          echo "âœ… No unoptimized <img> tags found"
        fi

    - name: ğŸ’¬ Comment PR Results  
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          
          try {
            const auditData = JSON.parse(fs.readFileSync('audit_results.json', 'utf8'));
            const findings = auditData.findings || [];
            const high = findings.filter(f => f.severity === 'HIGH');
            const medium = findings.filter(f => f.severity === 'MEDIUM');
            const low = findings.filter(f => f.severity === 'LOW');
            
            const status = high.length === 0 ? 'ğŸ† **QUALITY GATES PASSED**' : 'âŒ **QUALITY GATES FAILED**';
            
            const body = `${status}
            
            ## ğŸ“Š Code Quality Summary
            - **HIGH**: ${high.length} findings
            - **MEDIUM**: ${medium.length} findings  
            - **LOW**: ${low.length} findings
            
            ${high.length > 0 ? '### ğŸš¨ HIGH Priority Issues\n' + high.map(h => `- ${h.message}`).join('\n') : ''}
            
            ### ğŸ¯ Enterprise Standards
            âœ… Zero HIGH findings required for merge
            âœ… Function complexity < 120 lines
            âœ… No unoptimized <img> tags
            âœ… Bundle size within budget
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } catch (error) {
            console.log('Could not post comment:', error);
          }
        
    - name: âŒ Fail on Quality Gate Violations
      run: |
        python -c "
        import json, sys
        
        with open('audit_results.json') as f:
            data = json.load(f)
        
        high_findings = [f for f in data.get('findings', []) if f.get('severity') == 'HIGH']
        
        if high_findings:
            print(f'âŒ BLOCKING MERGE: {len(high_findings)} HIGH severity findings detected')
            for finding in high_findings:
                print(f'  - {finding.get(\"message\", \"Unknown issue\")}')
            sys.exit(1)
        else:
            print('âœ… All quality gates passed - merge approved')
        "

  # Job 2: Frontend Bundle Analysis  
  bundle-analysis:
    name: ğŸ“¦ Bundle Size & Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“± Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'apenas site/package-lock.json'
        
    - name: ğŸ“¦ Install Dependencies
      working-directory: ./apenas site
      run: npm ci
      
    - name: ğŸ—ï¸ Build with Bundle Analysis
      working-directory: ./apenas site
      run: |
        ANALYZE=true npm run build
      env:
        NODE_ENV: production
        
    - name: ğŸ“Š Check Bundle Size Budget
      working-directory: ./apenas site
      run: |
        echo "ğŸ” Checking bundle size budget..."
        
        # Verificar se .next/static existe
        if [ ! -d ".next/static" ]; then
          echo "âŒ Build artifacts not found"
          exit 1
        fi
        
        # Calcular tamanho total do bundle
        bundle_size=$(du -sb .next/static | cut -f1)
        bundle_size_kb=$((bundle_size / 1024))
        
        # Budget: 500KB para bundles iniciais
        budget_kb=500
        
        echo "Bundle size: ${bundle_size_kb}KB"
        echo "Budget: ${budget_kb}KB"
        
        if [ $bundle_size_kb -gt $budget_kb ]; then
          echo "âŒ BUNDLE SIZE EXCEEDED: ${bundle_size_kb}KB > ${budget_kb}KB"
          echo "Consider:"
          echo "- Lazy loading components with next/dynamic"
          echo "- Code splitting by routes"
          echo "- Tree shaking unused dependencies"
          exit 1
        else
          echo "âœ… Bundle size within budget: ${bundle_size_kb}KB <= ${budget_kb}KB"
        fi

  # Job 3: Integration Tests
  integration-tests:
    name: ğŸ”Œ Integration Tests
    runs-on: ubuntu-latest
    
    services:
      # Setup para FastAPI se necessÃ¡rio
      # backend:
      #   image: python:3.11
      #   options: --health-cmd "curl -f http://localhost:8000/health || exit 1"
    
    steps:
    - name: ğŸ“‚ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“± Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'apenas site/package-lock.json'
        
    - name: ğŸ“¦ Install All Dependencies
      run: |
        # Python
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests
        
        # Node.js
        cd "apenas site"
        npm ci
        
    - name: ğŸš€ Start Backend (Background)
      run: |
        python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000 &
        echo $! > backend.pid
        
        # Wait for backend to be ready
        echo "â³ Waiting for backend..."
        for i in {1..30}; do
          if curl -s http://localhost:8000/api/data/status > /dev/null; then
            echo "âœ… Backend ready"
            break
          fi
          sleep 2
        done
        
    - name: ğŸŒ Start Frontend (Background)
      working-directory: ./apenas site
      run: |
        npm run dev &
        echo $! > frontend.pid
        
        # Wait for frontend to be ready
        echo "â³ Waiting for frontend..."
        for i in {1..30}; do
          if curl -s http://localhost:3000 > /dev/null; then
            echo "âœ… Frontend ready"
            break
          fi
          sleep 2
        done
        
    - name: ğŸ§ª Run Integration Tests
      run: |
        python .ci/check_integration.py --ci
        
    - name: ğŸ›‘ Cleanup Processes
      if: always()
      run: |
        # Kill processes
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) || true
        fi
        if [ -f "apenas site/frontend.pid" ]; then
          kill $(cat "apenas site/frontend.pid") || true
        fi